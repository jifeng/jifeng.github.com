<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="description" content="MK2's blog，生命是一场幻觉，代码是一段人生。"/>
  <link rel="stylesheet" href="/css/typo.css" />
  <link rel="stylesheet" href="/css/prettify.css">
  <script src="/js/jquery-1.7.min.js"></script>
  <script src="/js/prettify.js"></script>
  <title>fibonacci(40) benchmark</title>
  <style>
     body {
      font-family: Helvetica, Arial, FreeSans, san-serif;
     }
     a{color:#09f;}
     code{color:#080;}
     h1, #tagline{display:inline;}
     #wrapper{padding:5% 8%;min-width:480px;}
     #tagline{font:0.8em serif;color:#888;display:inline-block;margin:0.1em 0 1.2em;}
     #fork{position:fixed;top:0;right:0;_position:absolute;}
  </style>
</head>
<body>

<div id="wrapper" class="typo">

<div id="header">
<h3><a href="/">Home</a> | <a href="../">Prev</a></h3>
</div> <!-- #header -->

<div id="content">
<h1>fibonacci(40) benchmark</h1>

<p><a href="http://teddziuba.com/2011/10/node-js-is-cancer.html">Node.js is Cancer</a> show a wrong way to use nodejs.<br />But the test code <strong><a href="http://en.wikipedia.org/wiki/Fibonacci">Fibonacci</a></strong> is so funny.<br />I implement the <strong>fibonacci function</strong> in other <strong><a href="http://en.wikipedia.org/wiki/Dynamic_programming_language">Dynamic Languages</a></strong> for comparison testing.</p>

<h2>Languages</h2>

<h3>Dynamic</h3>

<ul>
<li><a href="http://nodejs.org">nodejs</a></li>
<li><a href="http://kkaefer.github.com/node-cpp-modules">nodejs + cpp module</a></li>
<li><a href="http://python.org">python</a></li>
<li><a href="http://pypy.org/">pypy</a>: a fast, compliant alternative implementation of the Python language (2.7.1). </li>
<li><a href="http://perl.org">perl</a> </li>
<li><a href="http://www.php.net/">php</a></li>
<li><a href="http://www.ruby-lang.org/">ruby</a></li>
<li><a href="http://www.lua.org/">lua</a></li>
<li><a href="http://luajit.org/">luajit</a>: a Just-In-Time Compiler for Lua.</li>
</ul>

<h3>Static</h3>

<ul>
<li><a href="http://en.wikipedia.org/wiki/C_(programming_language)">c</a></li>
<li><a href="http://golang.org/">go</a></li>
</ul>

<p>If you want to help add more dynamic languagues, please leave the <strong>implement code</strong> in comments.</p>

<h2>Results</h2>

<p>(^_^) c > go > luajit > nodejs > pypy > lua > python > php > perl > ruby1.9.3 > ruby1.8.5 (T_T)</p>

<table>
  <tr><th>Language</th><th>Times</th><th>Position</th></tr>
  <tr><td style="color: green;">c</td><td>0m1.606s</td><td>#0</td></tr>
  <tr><td style="color: green;">go</td><td>0m1.769s</td><td>#1</td></tr>
  <tr><td style="color: green;">node + cpp module</td><td>0m2.216s</td><td>#2</td></tr>
  <tr><td style="color: green;">luajit</td><td>0m2.583s</td><td>#3</td></tr>
  <tr><td style="color: green;">nodejs</td><td>0m5.124s</td><td>#4</td></tr>
  <tr><td style="color: green;">pypy</td><td>0m7.562s</td><td>#5</td></tr>
  <tr><td>lua</td><td>0m34.492s</td><td>#6</td></tr>
  <tr><td>python</td><td>1m11.647s</td><td>#7</td></tr>
  <tr><td>php</td><td>1m28.198s</td><td>#8</td></tr>
  <tr><td>perl</td><td>2m34.658s</td><td>#9</td></tr>
  <tr><td style="color: red;">ruby 1.9.3</td><td>4m40.790s</td><td>#10</td></tr>
  <tr><td style="color: red;">ruby 1.8.5</td><td>4m41.942s</td><td>#11</td></tr>
</table>

<p><strong>lua</strong> use <em>local function</em> will get better performance.</p>

<h2>Test Codes</h2>

<h3>nodejs</h3>

<pre><code>function fibonacci(n) {
  if (n &lt; 2) {
    return 1;
  }
  return fibonacci(n - 2) + fibonacci(n - 1);
}

console.log(fibonacci(40));
</code></pre>

<p>run</p>

<pre><code>$ time node fibonacci.js
165580141

real  0m5.153s
user  0m5.124s
sys 0m0.012s
</code></pre>

<h3>nodejs + cpp module</h3>

<p>cppfibonacci.cpp</p>

<pre><code>#include &lt;node/v8.h&gt;
#include &lt;node/node.h&gt;

using namespace v8;

int fibonacci(int n) {
  if (n &lt; 2) {
    return 1;
  }
  return fibonacci(n - 1) + fibonacci(n - 2);
}

Handle&lt;Value&gt; Fibonacci(const Arguments&amp; args) {
    HandleScope scope;

    if (args.Length() &lt; 1) {
        return ThrowException(Exception::TypeError(
            String::New("First argument must be a number")));
    }
    Local&lt;Integer&gt; integer = args[0]-&gt;ToInteger();
int r = fibonacci(integer-&gt;Value());

    return scope.Close(Integer::New(r));
}

void RegisterModule(v8::Handle&lt;v8::Object&gt; target) {
    // Add properties to target
    NODE_SET_METHOD(target, "fibonacci", Fibonacci);
}

// Register the module with node.
NODE_MODULE(cppfibonacci, RegisterModule);
</code></pre>

<p>wscript</p>

<pre><code>#!/usr/bin/env python

def set_options(ctx):
  ctx.tool_options('compiler_cxx')

def configure(ctx):
  ctx.check_tool('compiler_cxx')
  ctx.check_tool('node_addon')

def build(ctx):
  t = ctx.new_task_gen('cxx', 'shlib', 'node_addon')

  t.source = ['cppfibonacci.cpp']

  # Must be same as first parameter in NODE_MODULE.
  t.target = 'cppfibonacci'
</code></pre>

<p>cppfibonacci.js</p>

<pre><code>var fibonacci = require('./build/default/cppfibonacci').fibonacci;
console.log(fibonacci(40));
</code></pre>

<p>run</p>

<pre><code>$ node-waf configure
$ node-waf build
$ time node cppfibonacci.js
165580141

real  0m2.224s
user  0m2.216s
sys 0m0.008s
</code></pre>

<h3>python2.4.3 &amp;&amp; python2.6.7 &amp;&amp; pypy1.7</h3>

<pre><code>def fibonacci(n):
    if n &lt; 2:
        return 1
    return fibonacci(n - 2) + fibonacci(n - 1)

print fibonacci(40)
</code></pre>

<p>run</p>

<pre><code>$ time python2.4.3 fibonacci.py
165580141

real  1m11.667s
user  1m11.647s
sys 0m0.002s

$ time python2.6.7 fibonacci.py
165580141

real  1m9.837s
user  1m9.792s
sys 0m0.006s

$ time ./pypy-1.7/bin/pypy fibonacci.py
165580141

real  0m7.608s
user  0m7.562s
sys 0m0.031s
</code></pre>

<h3>perl</h3>

<pre><code>sub fibonacci {
    my $n = shift;
    if ($n &lt; 2) {
      return 1;
    }
    return fibonacci($n - 2) + fibonacci($n - 1);
}

print fibonacci(40), "\n";
</code></pre>

<p>run</p>

<pre><code>$ time perl fibonacci.pl
165580141

real  2m34.777s
user  2m34.658s
sys 0m0.004s
</code></pre>

<h3>php</h3>

<pre><code>&lt;?php

function fibonacci($n) {
  if ($n &lt; 2) {
    return 1;
  }
  return fibonacci($n - 2) + fibonacci($n - 1);
}

echo fibonacci(40)."\n";

?&gt;
</code></pre>

<p>run</p>

<pre><code>$ time php fibonacci.php

165580141
real  1m28.364s
user  1m28.198s
sys 0m0.039s
</code></pre>

<h3>ruby1.8.5 &amp;&amp; ruby1.9.3</h3>

<pre><code>def fibonacci(n)
  if n &lt; 2
    return 1
  end
  return fibonacci(n - 2) + fibonacci(n - 1)
end

puts fibonacci(40)
</code></pre>

<p>run</p>

<pre><code>$ time ruby1.8.5 fibonacci.rb
165580141

real  5m43.132s
user  4m41.942s
sys 1m0.653s

$ time ruby1.9.3 fibonacci.rb
165580141

real  5m41.714s
user  4m40.790s
sys 1m0.661s
</code></pre>

<h3>lua &amp;&amp; luajit</h3>

<pre><code>function fibonacci(n)
  if n &lt; 2 then
    return 1
  end
  return fibonacci(n - 2) + fibonacci(n - 1)
end

io.write(fibonacci(40), "\n")
</code></pre>

<p>run</p>

<pre><code>$ time ./lua-5.1.4/src/lua fibonacci.lua 
165580141

real  0m34.514s
user  0m34.492s
sys 0m0.004s

$ time ./LuaJIT-2.0.0-beta9/src/luajit fibonacci.lua 
165580141

real  0m2.598s
user  0m2.583s
sys 0m0.001s
</code></pre>

<p>local function should be faster:</p>

<pre><code>local function fibonacci(n)
  if n &lt; 2 then
    return 1
  end
  return fibonacci(n - 2) + fibonacci(n - 1)
end

io.write(fibonacci(40), "\n")

$ time ./lua-5.1.4/src/lua fibonacci.lua.local
165580141

real  0m31.737s
user  0m31.549s
sys 0m0.001s

$ time ./LuaJIT-2.0.0-beta9/src/luajit fibonacci.lua.local
165580141

real  0m2.227s
user  0m2.225s
sys 0m0.001s
</code></pre>

<h3>c</h3>

<pre><code>#include &lt;stdio.h&gt;

int fibonacci(n) {
  if (n &lt; 2) {
    return 1;
  }
  return fibonacci(n - 2) + fibonacci(n - 1);
}

int main() {
  printf("%d\n", fibonacci(40));
  return 0;
}
</code></pre>

<p>run</p>

<pre><code>$ gcc fibonacci.c
$ time ./a.out 
165580141

real  0m3.434s
user  0m3.427s
sys 0m0.000s
</code></pre>

<p>Compilation with optimization:</p>

<pre><code>$ gcc -O2 fibonacci.c
$ time ./a.out 
165580141

real  0m1.607s
user  0m1.606s
sys 0m0.001s
</code></pre>

<p><a href="http://cnodejs.org/blog/?p=4982#comment-1875">@fool</a>: How about C++ meta programming, it’s a bit of cheating</p>

<pre><code>#include &lt;stdio.h&gt;

template&lt;int n&gt;
struct fibonacci {
    enum { Result = fibonacci&lt;n-2&gt;::Result + fibonacci&lt;n-1&gt;::Result };
};

template&lt;&gt;
struct fibonacci&lt;1&gt; {
    enum { Result = 1 };
};

template&lt;&gt;
struct fibonacci&lt;0&gt; {
    enum { Result = 1 };
};

int main(int argc, char *argv[])
{
    printf("%d\n", fibonacci&lt;40&gt;::Result);
    return 0;
}
</code></pre>

<p>run</p>

<pre><code>$ g++ fibonacci.template.cpp 
$ time ./a.out
165580141

real  0m0.002s
user  0m0.001s
sys 0m0.001s
</code></pre>

<h3>go</h3>

<pre><code>package main

import "fmt"

func fibonacci(n int) int{
  if (n &lt; 2) {
    return 1
  }
  return fibonacci(n - 2) + fibonacci(n - 1)
}

func main() {
  fmt.Println(fibonacci(10))
}
</code></pre>

<p>run</p>

<pre><code>$ 6g fibonacci.go
$ 6l fibonacci.6
$ time ./6.out
165580141

real  0m1.770s
user  0m1.769s
sys 0m0.001s
</code></pre>

<h2>Conclusion</h2>

<p><strong>nodejs</strong> is very <strong>FAST</strong>. <br /><strong>luajit</strong> 2X faster than nodejs, <strong>Shocking</strong>.</p>

<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'fengmk2github'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div> <!-- #content -->

<div id="footer">
</div> <!-- #footer -->

</div> <!-- #wrapper -->

<a href="https://github.com/fengmk2/mk2blog" id="fork">
    <img alt="Fork me on GitHub" src="http://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png">
</a>

<!-- Specific to this page -->
<script>
$(function() {
  // Deck initialization
  $('pre code').parent().addClass('prettyprint');
  prettyPrint();
});
</script>
</body>
</html>
