<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->  <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  

  <title> 那些年，在nodejs上踩过的坑 </title>
  <meta name="description" content="A jQuery library for modern HTML presentations">
  <meta name="author" content="Caleb Troughton">
  <meta name="viewport" content="width=1024, user-scalable=no">
  
  <!-- Core and extension CSS files -->
  <link rel="stylesheet" href="/js/deck.js/core/deck.core.css">
  <link rel="stylesheet" href="/js/deck.js/extensions/goto/deck.goto.css">
  <link rel="stylesheet" href="/js/deck.js/extensions/menu/deck.menu.css">
  <link rel="stylesheet" href="/js/deck.js/extensions/navigation/deck.navigation.css">
  <link rel="stylesheet" href="/js/deck.js/extensions/status/deck.status.css">
  <link rel="stylesheet" href="/js/deck.js/extensions/hash/deck.hash.css">
  
  <!-- Theme CSS files (menu swaps these out) -->
  <link rel="stylesheet" id="style-theme-link" href="/js/deck.js/themes/style/neon.css">
  <link rel="stylesheet" id="transition-theme-link" href="/js/deck.js/themes/transition/horizontal-slide.css">
  
  <!-- Custom CSS just for this page -->
  <link rel="stylesheet" href="/css/prettify.css">
  
  <script src="/js/deck.js/modernizr.custom.js"></script>
</head>

<body class="deck-container">


<section class="slide">
  <h1> 那些年 <br> 在nodejs上踩过的坑</h1>
</section>

<section class="slide">
<h2>大纲</h2>

<ul>
<li>循环优化</li>
<li>callback</li>
<li>buffer</li>
<li>深度嵌套</li>
<li>HTTP Request</li>
<li>HTTP Response</li>
</ul>

</section>

<section class="slide">
<h2>循环性能</h2>
<pre><code> 
forEach()
<br>
for (var prop in object)
<br>
for (var i = 0; i < length; i++)   and  while
</code></pre>
</section>

<section class="slide">
<h2>for</h2>

<pre><code> 
  for (var i = 0; i < data.length; i++) {
    //do something
  }

</code></pre>
<br>
<pre><code>
  for (var i = 0, l = data.length; i < l; i++) {
    //do something
  }
</code></pre>
</section>

<section class="slide">
<h2>callback</h2>
<pre><code>
  get(params, function(err, data) {
    if (err) {
      callback(err);
   }
    //对data进行操作
    var row = data[0];
  });
</code></pre>
</section>

<section class="slide">
<h2>callback</h2>
<pre><code>
  function asyncfun(data, callback) {
    try {
      callback(null, JSON.parse(data.toString()));
    } catch (e) {
      callback(e);
    }
  }
</code></pre>

<pre><code>
  var json = {'a': 'b'};
  var jsonstr = JSON.stringify(json);
  var d = new Buffer(jsonstr);

  asyncfun(d, function(err, data) {
    console.log(err);
    throw new Error('new Error');
  });
</code></pre>
<h3>执行结果</h3>
<pre><code>
  null
  [Error: new Error]
</code></pre>
</section>
<section class="slide">
<h2>buffer</h2>
<pre><code>
  var data = "";  
  res.on('data', function (chunk) {  
    data += chunk;  
  })  
  .on("end", function () {  

  });
</code></pre>
</section>

<section class="slide">
<h2>buffer</h2>
<h3>优化(1)</h3>
<pre><code>
  var chunks = [];  
  var size = 0;  
  res.on('data', function (chunk) {  
    chunks.push(chunk);  
    size += chunk.length;  
  });  
  res.on('end', function () {  
    data = new Buffer(size);  
    for (var i = 0, pos = 0, l = chunks.length; i < l; i++) {  
      var chunk = chunks[i];  
      chunk.copy(data, pos);  
      pos += chunk.length;  
    }  
  }); 
</code></pre>
</section>

<section class="slide">
<h2>buffer</h2>
<h3>优化(2)</h3>
<pre><code>
  res.on('end', function () {  
  var data = null;  
  switch(chunks.length) {  
    case 0: data = new Buffer(0);  
      break;  
    case 1: data = chunks[0];  
      break;  
    default:  
      data = new Buffer(size);  
      for (var i = 0, pos = 0, l = chunks.length; i < l; i++) {  
        var chunk = chunks[i];  
        chunk.copy(data, pos);  
        pos += chunk.length;  
      }  
      break;  
  }  
}); 
</code></pre>
</section>

<section class="slide">
<h2>深度嵌套</h2>
<h3>典型代码</h3>
<pre><code>N
  func1(err, function(err1, data1) {
    func2(err1, function(err2, data2) {
      func3(err3, function(err3, data3) {
        func4(err4, function(err4, data4) {
          .......
        })
      })
    })
  })
</code></pre>

</section>

<section class="slide">
<h2>单元测试——小技巧</h2>
<h3>模拟请求得到的数据</h3>
<pre><code> 
var searchApp = require('../controllers/search');
var app = require('../app').create();
var should = require('should');  
  before(function(done) {
    app.listen(0, done);
  });
    describe('/cpv_items', function() {
    var urls = [
      '/cpv_items/50010850/20511,28386;20664,28105;2917619,8496965?query=%E8%BF%9E%E8%A1%A3%E8%A3%99&cid=50010850&hot=63426&title=%E8%95%BE%E4%B8%9D%20%E8%95%BE%E4%B8%9D%E8%8A%B1%E8%BE%B9%20%E9%9F%A9%E7%89%88&datatype=cpv',
      '/cpv_items/50019272/20000,47342;3775809,20144;7221242,4526599?query=%E7%99%BB%E5%B1%B1%E9%9E%8B&cid=50019272&hot=13451&title=%E7%94%B7%E5%A3%AB%20Camel%2F%E9%AA%86%E9%A9%BC%20%E8%80%90%E7%A3%A8&datatype=cpv',
    ];
    urls.forEach(function(url) {
      it(url.substring(0, 30) + '... should return json format', function(done) {
        app.request().get(url).end(function(res) {
          res.should.have.status(200);
          res.should.have.header('content-type', 'application/json; charset=utf-8');
          var items = JSON.parse(res.body);
          items.should.be.an.instanceof(Array);
          items.length.should.above(0);
          for (var j = 0, jl = items.length; j < jl; j++) {
            checkImageItem(items[j]);
          }
          done();
        });
      })
    });
    
  });
	......
</code></pre>
<p><a href="http://svn.simba.taobao.com/svn/EDP/taobaoindex/taobaoindex/trunk/test/support/http.js">http模拟代码</a></p>
</section>

<section class="slide">
<h2>单元测试——小技巧</h2>
<h3>模拟http请求</h3>
<pre><code> 
function mockDataRenderError() {
  var _request = urllib.request;
  before(function() {
    urllib.request = function() {
      var cb = arguments[arguments.length - 1];
      process.nextTick(function() {
        cb(null, new Buffer('{"v": "3.0","c": 200,"m": "数据渲染错误","t": 0,"n": 0,"fn": 0}'));
      });
    };
  });
  after(function() {
    urllib.request = _request;
  });
  return function(err, data, done) {
    should.exist(err);
    err.should.be.an.instanceof(Error);
    err.message.should.equal('数据渲染错误');
    err.data.should.equal('{"v": "3.0","c": 200,"m": "数据渲染错误","t": 0,"n": 0,"fn": 0}');
    should.not.exist(data);
    done();
  };
}
	......
</code></pre>

</section>
<section class="slide">
<h2>单元测试</h2>
<p><img src="http://ww4.sinaimg.cn/large/7013266egw1drev57wf27j.jpg" alt="result" title="" /></p>
<p>看见单元测试全部跑过是件很爽的事情</p>
</section>


<section class="slide">
<h1> Thank you</h1></section>


<p class="deck-status">
  <span class="deck-status-current"></span>
  /
  <span class="deck-status-total"></span>
</p>

<form action="." method="get" class="goto-form">
  <label for="goto-slide">Go to slide:</label>
  <input type="text" name="slidenum" id="goto-slide" list="goto-datalist">
  <datalist id="goto-datalist"></datalist>
  <input type="submit" value="Go">
</form>

<a href="." title="Permalink to this slide" class="deck-permalink">#</a>

<script src="/js/jquery-1.7.min.js"></script>
<script src="/js/prettify.js"></script>

<!-- Deck Core and extensions -->
<script src="/js/deck.js/core/deck.core.js"></script>
<script src="/js/deck.js/extensions/hash/deck.hash.js"></script>
<script src="/js/deck.js/extensions/menu/deck.menu.js"></script>
<script src="/js/deck.js/extensions/goto/deck.goto.js"></script>
<script src="/js/deck.js/extensions/status/deck.status.js"></script>
<script src="/js/deck.js/extensions/navigation/deck.navigation.js"></script>

<!-- Specific to this page -->
<script>
$(function() {
  // Deck initialization
  $.deck('.slide');
  $('pre code').parent().addClass('prettyprint');
  prettyPrint();
});
</script>

</body>
</html>